[build-system]
build-backend = "uv_build"
requires = [ "uv-build>=0.1" ]

[project]
name = "yosoi"
version = "0.0.1a5"
description = "AI-Powered Selector Discovery - Discover once, scrape forever"
readme = "README.md"
license = { file = "LICENSE.md" }
requires-python = ">=3.10"
classifiers = [
  "Development Status :: 4 - Beta",
  "Intended Audience :: Developers",
  "Programming Language :: Python :: 3 :: Only",
  "Programming Language :: Python :: 3.10",
  "Programming Language :: Python :: 3.11",
  "Programming Language :: Python :: 3.12",
  "Programming Language :: Python :: 3.13",
  "Programming Language :: Python :: 3.14",
  "Topic :: Internet :: WWW/HTTP :: Dynamic Content",
  "Topic :: Software Development :: Libraries :: Python Modules",
]

dependencies = [
  "beautifulsoup4>=4.12",
  "brotli>=1.1",
  "logfire>=4.16",
  "lxml>=6.0.2",
  "pydantic>=2",
  "pydantic-ai>=0.0.16",
  "python-dotenv>=1.2.1",
  "requests>=2.31",
  "rich>=14.2",
]

scripts.yosoi = "yosoi.cli:main"
Homepage = "https://https://cascadinglabs.com/yosoi/"
Repository = "https://github.com/CascadingLabs/Yosoi"
Issues = "https://github.com/CascadingLabs/Yosoi/issues"
Changelog = "https://github.com/CascadingLabs/Yosoi/blob/main/CHANGELOG.md"

[dependency-groups]
dev = [
  "commitizen>=3.13",
  "memray>=1.19.1",
  "mypy>=1.8",
  "playwright>=1.58",
  "poethepoet>=0.40",
  "prek>=0.2.25",
  "types-beautifulsoup4>=4.12",
  "types-requests>=2.31",
]
tests = [
  "deepeval>=3.8.4",
  "dirty-equals>=0.11",
  "poethepoet>=0.40",
  "polyfactory>=3.2",
  "pytest>=9.0.2",
  "pytest-asyncio>=1.3",
  "pytest-cov>=7",
  "pytest-mock>=3.15.1",
  "pytest-sugar>=1.1.1",
  "pytest-xdist>=3.8",
  "respx>=0.22",
  "syrupy>=5.1",
  "testcontainers>=4.14.1",
]

[tool.uv]
package = true

[tool.uv.build-backend]
module-name = "yosoi"
module-root = ""      # This tells uv the package is in the root, not src/

source-exclude = [
  "tests/**",
  "docs/**",
  "examples/**",
  "**/*.pyc",
  "**/__pycache__",
  ".venv/**",
  ".env",
  ".env.example",
  ".yosoi/**",
  ".logfire/**",
  ".ruff_cache/**",
  ".pytest_cache/**",
  ".mypy_cache/**",
  "uv.lock",
  "AGENTS.md",
  "urls.txt",
  "CONTRIBUTING.md",
]

[tool.ruff]
target-version = "py310"
line-length = 120
indent-width = 4

format.quote-style = "single"
format.line-ending = "auto"
format.skip-magic-trailing-comma = false

lint.select = [
  "ARG",  # flake8-unused-arguments
  "B",    # flake8-bugbear
  "C901", # mccabe complexity
  "D",    # pydocstyle
  "E",    # pycodestyle errors
  "F",    # pyflakes
  "I",    # isort
  "PERF", # performance
  "RET",  # flake8-return
  "SIM",  # flake8-simplify
  "TID",  # flake8-tidy-imports
  "UP",   # pyupgrade
  "W",    # pycodestyle warnings
]

lint.ignore = [
  "ARG001", # unused args are common in dynamic APIs
  "B008",   # allow function calls in defaults when intentional
  "E402",   # module level import not at top of file
  "E501",   # formatter handles line length
  "RET504", # allow implicit return None
  "SIM108", # allow if-else instead of ternary
  "W293",   # blank line contains whitespace
]
lint.per-file-ignores."tests/**/*.py" = [
  "ARG001", # unused arguments in test functions
  "ARG002", # unused method arguments in tests
  "D",      # pydocstyle - no docstrings required for tests
]
lint.mccabe.max-complexity = 13

[tool.pytest.ini_options]
markers = [
  "eval: mark test as an evaluation test (requires real LLM and is slow)",
]

[tool.mypy]
python_version = "3.10"

warn_unused_configs = true
warn_return_any = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_unreachable = true
strict_equality = true
check_untyped_defs = true
no_implicit_optional = true

# Progressive strictness - enable these when ready
disallow_untyped_defs = false    # TODO: Enable for full type coverage
disallow_any_generics = false    # TODO: Enable for stricter generics
disallow_subclassing_any = false
disallow_untyped_calls = false
disallow_incomplete_defs = false

show_error_codes = true
show_column_numbers = true
pretty = true

ignore_missing_imports = true

[[tool.mypy.overrides]]
module = [
  "scrapegraphai.*",
  "langchain.*",
  "langchain_google_genai.*",
  "langchain_core.*",
  "langchain_community.*",
  "dspy.*",
  "toonify.*",
]
ignore_missing_imports = true

[tool.poe.tasks]
eval = 'uv run pytest -m "eval"'                                                    # run deepeval tests
integration = "uv run pytest -m 'integration'"                                      # run integration tests
unit = "uv run pytest -m 'unit'"                                                    # run unit tests
ci-test = "uv run pytest -m 'not eval'"
ci-check = "uv run prek run --all-files --hook-stage manual --show-diff-on-failure"

[tool.gitleaks]
[[tool.gitleaks.allowlist]]
paths = [
  '''.*\.md$''',
]
regexes = [
  '''llama-3\.3-70b-versatile''', # Model name, not a secret
  '''gemini-2\.0-flash-exp''',    # Model name, not a secret
]

# Configuration for Gitleaks moved to pyproject.toml

[[tool.gitleaks.rules]]
id = "generic-api-key"
description = "Generic API Key"
regex = '''(?i)(?:key|api|token|secret|password)[\s]*[=:>]{1}[\s]*['"]?([a-z0-9_\-]{20,})['"]?'''
entropy = 4.5

[tool.commitizen]
name = "cz_conventional_commits"
tag_format = "v$version"
version_scheme = "semver"
version_provider = "pep621"      # Reads/updates version in [project] section of pyproject.toml
update_changelog_on_bump = true
major_version_zero = true        # Keeps you in 0.x.x (beta) semantics

types = [
  { value = "feat", name = "feat: A new feature" },
  { value = "fix", name = "fix: A bug fix" },
  { value = "docs", name = "docs: Documentation only changes" },
  { value = "style", name = "style: Formatting (ruff, black, etc)" },
  { value = "refactor", name = "refactor: Code change that neither fixes a bug nor adds a feature" },
  { value = "perf", name = "perf: A code change that improves performance" },
  { value = "test", name = "test: Adding or correcting tests" },
  { value = "build", name = "build: Changes that affect the build system (uv, pyproject.toml)" },
  { value = "ci", name = "ci: CI configuration (GitHub Actions)" },
  { value = "chore", name = "chore: Other changes that don't modify src or test files" },
]
